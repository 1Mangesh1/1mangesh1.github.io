---
import Layout from '../layouts/Layout.astro';

const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxxRtJRGDs9Mb6ZK_m6ExxVnaR2jfeHVT-TpmOWOZXetyzJYpLYppDMzPrqOedFTb9ZLg/exec'
---

<Layout title="Guestbook - Mangesh Bide" description="Leave a message in my digital guestbook">
  <div class="min-h-screen">
    <!-- Subtle gradient background -->
    <div class="absolute inset-0 bg-gradient-to-br from-slate-50 via-white to-slate-100 dark:from-slate-900 dark:via-gray-900 dark:to-slate-800 -z-10"></div>

    <div class="max-w-2xl mx-auto px-4 py-16">
      <!-- Header -->
      <header class="text-center mb-12">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-sm mb-4">
          <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
          <span>Live guestbook</span>
        </div>
        <h1 class="text-3xl font-light tracking-tight text-slate-900 dark:text-slate-100 mb-3">
          Sign the Guestbook
        </h1>
        <p class="text-slate-500 dark:text-slate-400 font-light">
          Leave a note, say hello, or share a thought
        </p>
      </header>

      <!-- Sign Form -->
      <div class="mb-12">
        <form id="guestbook-form" class="space-y-4">
          <div class="grid gap-4">
            <div class="flex gap-3">
              <input
                type="text"
                id="name"
                required
                maxlength="50"
                class="flex-1 px-4 py-3 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-300 dark:focus:ring-slate-600 focus:border-transparent transition-all"
                placeholder="Your name"
              />
              <input
                type="url"
                id="website"
                maxlength="100"
                class="w-1/3 px-4 py-3 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-300 dark:focus:ring-slate-600 focus:border-transparent transition-all"
                placeholder="Website (optional)"
              />
            </div>
            <div class="relative">
              <textarea
                id="message"
                required
                maxlength="280"
                rows="3"
                class="w-full px-4 py-3 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-300 dark:focus:ring-slate-600 focus:border-transparent transition-all resize-none"
                placeholder="Write something..."
              ></textarea>
              <span id="char-count" class="absolute bottom-3 right-3 text-xs text-slate-400">0/280</span>
            </div>
          </div>
          <button
            type="submit"
            id="submit-btn"
            class="w-full py-3 px-4 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-xl font-medium hover:bg-slate-800 dark:hover:bg-slate-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Post message
          </button>
          <p class="text-xs text-slate-400 text-center mt-3">
            Messages are reviewed before appearing
          </p>
        </form>
        <div id="submit-status" class="hidden mt-4 p-3 rounded-xl text-center text-sm"></div>
      </div>

      <!-- Divider -->
      <div class="flex items-center gap-4 mb-8">
        <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
        <span class="text-xs text-slate-400 uppercase tracking-wider">Messages</span>
        <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
      </div>

      <!-- Messages -->
      <div id="messages" class="space-y-4">
        <div class="flex items-center justify-center py-12">
          <div class="w-5 h-5 border-2 border-slate-300 dark:border-slate-600 border-t-slate-600 dark:border-t-slate-300 rounded-full animate-spin"></div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Subtle hover effect for message cards */
  .message-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .message-card:hover {
    transform: translateY(-1px);
  }
</style>

<script define:vars={{ GOOGLE_SCRIPT_URL }}>
  const form = document.getElementById('guestbook-form');
  const messagesContainer = document.getElementById('messages');
  const messageInput = document.getElementById('message');
  const charCount = document.getElementById('char-count');
  const submitBtn = document.getElementById('submit-btn');
  const submitStatus = document.getElementById('submit-status');

  const isConfigured = GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.length > 0;

  messageInput.addEventListener('input', () => {
    charCount.textContent = `${messageInput.value.length}/280`;
  });

  const STORAGE_KEY = 'guestbook_messages';

  function loadLocalMessages() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : getDefaultMessages();
    } catch {
      return getDefaultMessages();
    }
  }

  function saveLocalMessage(entry) {
    const messages = loadLocalMessages();
    messages.push(entry);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  }

  function getDefaultMessages() {
    return [
      {
        name: 'Mangesh',
        website: 'https://mangeshbide.tech',
        message: 'Welcome to the guestbook! Feel free to leave a message.',
        timestamp: new Date(Date.now() - 86400000).toISOString()
      }
    ];
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const diff = Date.now() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function isValidUrl(string) {
    try {
      const url = new URL(string);
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
      return false;
    }
  }

  // Generate consistent color from name
  function getAvatarColor(name) {
    const colors = [
      'from-rose-400 to-pink-500',
      'from-violet-400 to-purple-500',
      'from-blue-400 to-indigo-500',
      'from-cyan-400 to-teal-500',
      'from-emerald-400 to-green-500',
      'from-amber-400 to-orange-500',
      'from-slate-400 to-slate-500'
    ];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
  }

  function renderMessage(entry) {
    const avatarColor = getAvatarColor(entry.name);
    return `
      <div class="message-card group">
        <div class="flex gap-3">
          <div class="w-9 h-9 rounded-full bg-gradient-to-br ${avatarColor} flex items-center justify-center text-white text-sm font-medium shrink-0">
            ${entry.name.charAt(0).toUpperCase()}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-baseline gap-2 mb-1">
              ${entry.website && isValidUrl(entry.website)
                ? `<a href="${escapeHtml(entry.website)}" target="_blank" rel="noopener noreferrer" class="font-medium text-slate-900 dark:text-slate-100 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">${escapeHtml(entry.name)}</a>`
                : `<span class="font-medium text-slate-900 dark:text-slate-100">${escapeHtml(entry.name)}</span>`
              }
              <span class="text-xs text-slate-400">${formatTime(entry.timestamp)}</span>
            </div>
            <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">${escapeHtml(entry.message)}</p>
          </div>
        </div>
      </div>
    `;
  }

  function renderMessages(messages) {
    if (messages.length === 0) {
      messagesContainer.innerHTML = `
        <div class="text-center py-12 text-slate-400">
          <p class="text-sm">No messages yet. Be the first to sign!</p>
        </div>
      `;
      return;
    }

    messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    messagesContainer.innerHTML = messages.map(renderMessage).join('');
  }

  async function fetchMessages() {
    if (isConfigured) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL);
        if (response.ok) {
          const data = await response.json();
          renderMessages(data);
          return;
        }
      } catch (error) {
        console.error('Failed to fetch:', error);
      }
    }
    renderMessages(loadLocalMessages());
  }

  async function submitMessage(name, website, message) {
    const entry = {
      name,
      website: website || '',
      message,
      timestamp: new Date().toISOString()
    };

    if (isConfigured) {
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entry)
        });
        showStatus('Message submitted! It will appear after review.', 'success');
        saveLocalMessage(entry);
        setTimeout(fetchMessages, 1500);
        return true;
      } catch (error) {
        showStatus('Saved locally', 'warning');
        saveLocalMessage(entry);
        renderMessages(loadLocalMessages());
        return false;
      }
    } else {
      saveLocalMessage(entry);
      renderMessages(loadLocalMessages());
      showStatus('Message saved!', 'success');
      return true;
    }
  }

  function showStatus(message, type) {
    submitStatus.textContent = message;
    submitStatus.classList.remove('hidden');
    submitStatus.className = 'mt-4 p-3 rounded-xl text-center text-sm';

    if (type === 'success') {
      submitStatus.classList.add('bg-emerald-50', 'dark:bg-emerald-900/20', 'text-emerald-700', 'dark:text-emerald-300');
    } else {
      submitStatus.classList.add('bg-amber-50', 'dark:bg-amber-900/20', 'text-amber-700', 'dark:text-amber-300');
    }

    setTimeout(() => submitStatus.classList.add('hidden'), 3000);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    const website = document.getElementById('website').value.trim();
    const message = messageInput.value.trim();

    if (!name || !message) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Posting...';

    await submitMessage(name, website, message);

    submitBtn.disabled = false;
    submitBtn.textContent = 'Post message';
    form.reset();
    charCount.textContent = '0/280';
  });

  fetchMessages();
</script>
