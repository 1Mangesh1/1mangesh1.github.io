---
import Layout from '../layouts/Layout.astro';
---

<Layout 
  title="Simple GoatCounter Test" 
  description="Minimal GoatCounter test to isolate 403 issues"
  noindex={true}
>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-6">Simple GoatCounter Test</h1>
    
    <div class="space-y-8">
      <!-- Basic Test -->
      <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
        <h2 class="text-2xl font-semibold mb-4">Basic Test</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Testing basic GoatCounter functionality
        </p>
        
        <div id="basic-test" class="text-sm text-gray-600 dark:text-gray-400">
          Loading...
        </div>
      </div>

      <!-- Manual Test -->
      <div class="bg-blue-50 dark:bg-blue-900 p-6 rounded-lg">
        <h2 class="text-2xl font-semibold mb-4">Manual Test</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Test GoatCounter API manually
        </p>
        
        <button 
          id="test-button" 
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
        >
          Test GoatCounter API
        </button>
        
        <div id="test-result" class="mt-4 p-4 bg-white dark:bg-gray-800 rounded border hidden">
          <pre id="result-content" class="text-xs overflow-auto"></pre>
        </div>
      </div>

      <!-- Direct URL Test -->
      <div class="bg-green-50 dark:bg-green-900 p-6 rounded-lg">
        <h2 class="text-2xl font-semibold mb-4">Direct URL Test</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Test direct GoatCounter URLs
        </p>
        
        <div class="space-y-2">
          <button 
            id="test-count-url" 
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors mr-2"
          >
            Test /count URL
          </button>
          
          <button 
            id="test-counter-url" 
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
          >
            Test /counter URL
          </button>
        </div>
        
        <div id="url-test-result" class="mt-4 p-4 bg-white dark:bg-gray-800 rounded border hidden">
          <pre id="url-result-content" class="text-xs overflow-auto"></pre>
        </div>
      </div>

      <!-- Status Check -->
      <div class="bg-yellow-50 dark:bg-yellow-900 p-6 rounded-lg">
        <h2 class="text-2xl font-semibold mb-4">Status Check</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Check GoatCounter script and API status
        </p>
        
        <div id="status-check" class="space-y-2 text-sm">
          <div><strong>Script Loaded:</strong> <span id="script-status">Checking...</span></div>
          <div><strong>API Available:</strong> <span id="api-status">Checking...</span></div>
          <div><strong>Current Domain:</strong> <span id="domain-status">Checking...</span></div>
          <div><strong>GoatCounter URL:</strong> <span id="url-status">Checking...</span></div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Status check
  document.addEventListener('DOMContentLoaded', function() {
    // Check script status
    const scriptStatus = document.getElementById('script-status');
    if (scriptStatus) {
      if (typeof window.goatcounter !== 'undefined') {
        scriptStatus.textContent = '✅ Loaded';
        scriptStatus.className = 'text-green-600';
      } else {
        scriptStatus.textContent = '❌ Not loaded';
        scriptStatus.className = 'text-red-600';
      }
    }
    
    // Check API status
    const apiStatus = document.getElementById('api-status');
    if (apiStatus) {
      if (typeof window.goatcounter !== 'undefined' && typeof window.goatcounter.visit_count === 'function') {
        apiStatus.textContent = '✅ Available';
        apiStatus.className = 'text-green-600';
      } else {
        apiStatus.textContent = '❌ Not available';
        apiStatus.className = 'text-red-600';
      }
    }
    
    // Check domain
    const domainStatus = document.getElementById('domain-status');
    if (domainStatus) {
      domainStatus.textContent = window.location.hostname;
    }
    
    // Check GoatCounter URL
    const urlStatus = document.getElementById('url-status');
    if (urlStatus) {
      urlStatus.textContent = 'https://mangeshbide.goatcounter.com/count';
    }
  });

  // Basic test
  document.addEventListener('DOMContentLoaded', function() {
    const basicTest = document.getElementById('basic-test');
    if (basicTest) {
      setTimeout(() => {
        if (typeof window.goatcounter !== 'undefined') {
          basicTest.textContent = '✅ GoatCounter script loaded successfully';
          basicTest.className = 'text-sm text-green-600 dark:text-green-400';
        } else {
          basicTest.textContent = '❌ GoatCounter script failed to load';
          basicTest.className = 'text-sm text-red-600 dark:text-red-400';
        }
      }, 2000);
    }
  });

  // Manual test button
  document.getElementById('test-button')?.addEventListener('click', function() {
    const result = document.getElementById('test-result');
    const content = document.getElementById('result-content');
    
    if (!result || !content) return;
    
    try {
      if (typeof window.goatcounter === 'undefined') {
        content.textContent = '❌ GoatCounter not loaded';
        result.classList.remove('hidden');
        return;
      }
      
      if (typeof window.goatcounter.visit_count !== 'function') {
        content.textContent = '❌ visit_count function not available';
        result.classList.remove('hidden');
        return;
      }
      
      // Test the API
      window.goatcounter.visit_count({
        append: "#test-result",
        no_branding: true,
        type: "html"
      });
      
      content.textContent = '✅ API test successful - check for visitor count above';
      result.classList.remove('hidden');
      
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      content.textContent = `❌ API test failed: ${errorMessage}`;
      result.classList.remove('hidden');
    }
  });

  // URL tests
  document.getElementById('test-count-url')?.addEventListener('click', function() {
    const result = document.getElementById('url-test-result');
    const content = document.getElementById('url-result-content');
    
    if (!result || !content) return;
    
    fetch('https://mangeshbide.goatcounter.com/count')
      .then(response => {
        content.textContent = `Status: ${response.status} ${response.statusText}\nHeaders: ${JSON.stringify([...response.headers.entries()], null, 2)}`;
        result.classList.remove('hidden');
      })
      .catch(error => {
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        content.textContent = `❌ Count URL test failed: ${errorMessage}`;
        result.classList.remove('hidden');
      });
  });

  document.getElementById('test-counter-url')?.addEventListener('click', function() {
    const result = document.getElementById('url-test-result');
    const content = document.getElementById('url-result-content');
    
    if (!result || !content) return;
    
    fetch('https://mangeshbide.goatcounter.com/counter//.json')
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      })
      .then(data => {
        content.textContent = `✅ Counter URL test successful\nResponse: ${JSON.stringify(data, null, 2)}`;
        result.classList.remove('hidden');
      })
      .catch(error => {
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        content.textContent = `❌ Counter URL test failed: ${errorMessage}`;
        result.classList.remove('hidden');
      });
  });
</script> 