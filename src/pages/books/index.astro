---
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// Filter drafts in production, show all in development
const allBooks = await getCollection('books', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

const reading: CollectionEntry<'books'>[] = [];
const completed: CollectionEntry<'books'>[] = [];
const wantToRead: CollectionEntry<'books'>[] = [];

for (const book of allBooks) {
  if (book.data.status === 'reading') {
    reading.push(book);
  } else if (book.data.status === 'completed') {
    completed.push(book);
  } else if (book.data.status === 'want-to-read') {
    wantToRead.push(book);
  }
}

completed.sort((a, b) => (b.data.finishDate?.getTime() || 0) - (a.data.finishDate?.getTime() || 0));

const renderStars = (rating: number | undefined) => {
  if (!rating) return '';
  return 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
};

---

<Layout title="Books">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <div class="mb-12">
      <h1 class="text-4xl font-bold mb-4">Books</h1>
      <p class="text-gray-600 dark:text-gray-400">What I'm reading, have read, and want to read</p>
    </div>

    {reading.length > 0 && (
      <section class="mb-12">
        <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
          <span class="text-green-500">ğŸ“–</span> Currently Reading
        </h2>
        <div class="grid gap-4">
          {reading.map((book) => (
            <a
              href={`/books/${book.slug}`}
              class="block border-2 border-green-300 dark:border-green-600 rounded-lg p-6 hover:shadow-lg transition-all"
            >
              <h3 class="text-xl font-semibold mb-1">{book.data.title}</h3>
              <p class="text-gray-600 dark:text-gray-400 mb-2">by {book.data.author}</p>
              {book.data.tags && (
                <div class="flex flex-wrap gap-2">
                  {book.data.tags.map((tag) => (
                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs rounded">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </a>
          ))}
        </div>
      </section>
    )}

    {completed.length > 0 && (
      <section class="mb-12">
        <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
          <span class="text-blue-500">âœ“</span> Completed ({completed.length})
        </h2>
        <div class="grid gap-4">
          {completed.map((book) => (
            <a
              href={`/books/${book.slug}`}
              class="block border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-lg hover:border-blue-300 dark:hover:border-blue-600 transition-all"
            >
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-semibold mb-1">
                    {book.data.favorite && <span class="text-red-500 mr-1">â¤ï¸</span>}
                    {book.data.title}
                  </h3>
                  <p class="text-gray-600 dark:text-gray-400 text-sm">by {book.data.author}</p>
                </div>
                {book.data.rating && (
                  <span class="text-yellow-500">{renderStars(book.data.rating)}</span>
                )}
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {wantToRead.length > 0 && (
      <section>
        <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
          <span class="text-yellow-500">ğŸ“š</span> Want to Read ({wantToRead.length})
        </h2>
        <div class="grid gap-3">
          {wantToRead.map((book) => (
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <h3 class="font-semibold">{book.data.title}</h3>
              <p class="text-gray-600 dark:text-gray-400 text-sm">by {book.data.author}</p>
            </div>
          ))}
        </div>
      </section>
    )}
  </div>
</Layout>
