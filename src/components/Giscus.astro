<div class="giscus-wrapper mt-16 pt-8 border-t border-gray-200 dark:border-gray-700">
  <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Comments</h2>
  <div class="giscus-container"></div>
</div>

<style is:global>
  .giscus-wrapper {
    width: 100%;
  }

  .giscus-container {
    width: 100%;
    min-width: 0;
  }

  /* Target giscus wrapper created by the client script */
  .giscus-container .giscus {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Target the giscus iframe */
  .giscus-container .giscus iframe,
  .giscus-container .giscus .giscus-frame,
  .giscus-container iframe.giscus-frame {
    width: 100% !important;
    max-width: 100% !important;
  }
</style>

<script>
  function loadGiscus() {
    const wrapper = document.querySelector('.giscus-container');
    if (!wrapper) return;

    // Prevent double loading
    if (wrapper.querySelector('iframe') || wrapper.querySelector('.giscus')) return;

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', '1mangesh1/1mangesh1.github.io');
    script.setAttribute('data-repo-id', 'R_kgDONJZqoA');
    script.setAttribute('data-category', 'Comments');
    script.setAttribute('data-category-id', 'DIC_kwDONJZqoM4C2FCx');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-lang', 'en');
    script.setAttribute('data-loading', 'lazy');
    script.crossOrigin = 'anonymous';
    script.async = true;

    // Check if running on localhost
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

    // Determine initial theme
    const isDark = document.documentElement.classList.contains('dark') ||
                   (localStorage.getItem('theme') === 'dark') ||
                   (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);

    // Construct theme URL or use default for localhost
    const origin = window.location.origin;
    let themeUrl: string;

    if (isLocalhost) {
      console.warn('Giscus custom theme is disabled on localhost. Using built-in themes.');
      themeUrl = isDark ? 'dark' : 'light';
    } else {
      themeUrl = isDark
        ? `${origin}/styles/giscus-dark.css`
        : `${origin}/styles/giscus-light.css`;
    }

    script.setAttribute('data-theme', themeUrl);

    // Append the script to the wrapper â€” giscus will create a .giscus div as a sibling
    wrapper.appendChild(script);

    // Watch for the iframe to appear and force full width
    const iframeWatcher = new MutationObserver(() => {
      const iframe = wrapper.querySelector<HTMLIFrameElement>('iframe');
      if (iframe) {
        iframe.style.setProperty('width', '100%', 'important');
        iframe.style.setProperty('max-width', '100%', 'important');
      }
      // Also ensure the .giscus wrapper div is full width
      const giscusDiv = wrapper.querySelector<HTMLElement>('.giscus');
      if (giscusDiv) {
        giscusDiv.style.setProperty('width', '100%', 'important');
        giscusDiv.style.setProperty('max-width', '100%', 'important');
      }
    });
    iframeWatcher.observe(wrapper, { childList: true, subtree: true, attributes: true });

    // Theme toggling logic
    function setGiscusTheme(theme: string) {
      const iframe = document.querySelector('iframe.giscus-frame') as HTMLIFrameElement | null;
      if (!iframe) return;

      let newThemeUrl: string;

      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        newThemeUrl = theme === 'dark' ? 'dark' : 'light';
      } else {
        newThemeUrl = theme === 'dark'
          ? `${window.location.origin}/styles/giscus-dark.css`
          : `${window.location.origin}/styles/giscus-light.css`;
      }

      iframe.contentWindow?.postMessage(
        { giscus: { setConfig: { theme: newThemeUrl } } },
        'https://giscus.app'
      );
    }

    // Observer for theme changes
    const themeObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const isDarkNow = document.documentElement.classList.contains('dark');
          setGiscusTheme(isDarkNow ? 'dark' : 'light');
        }
      });
    });

    themeObserver.observe(document.documentElement, { attributes: true });
  }

  // Load on idle or immediately
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGiscus);
  } else {
    loadGiscus();
  }

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', loadGiscus);
</script>
